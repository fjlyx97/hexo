---
title: 高并发系统设计
date: 2020-07-18 14:09:10
tags:
- linux
- 学习
- 并发
categories : "Linux"
---

> - 高并发系统设计笔记
> - 基于极客时间专栏

<!-- more-->


# 性能的度量指标
明确度量指标十分重要，单次响应时间没有意义，应当关注一段时间的性能是什么样的。依据一些统计方法计算出特征值，这些特征值可以反应在这段时间的性能情况。常用的指标如下：

## 平均值
这段时间响应时间相加，除以总数。这种方案敏感性较差，如果出现了慢请求，无法如实反映出实际情况

## 最大值
请求时间最长的值。和平均值相比，太过敏感。

## 分位值
分位值分为很多种，比如90分位，95分位，75分位。把这段响应时间从小到大排序，假设100个请求，排在第90位的响应时间就是90分位值。这种方案可以排除偶发的慢请求对数据的影响，很好的反应出这段时间的性能情况，分位值越大，对于慢请求的影响就越敏感。
- 分位值适合在时间段内，响应时间统计值来使用，在实际应用中也应用的最多。
- 通常描述：在每秒 1 万次的请求量下，响应时间 99 分位值在 10ms 以下。

## 分界点
从用户体验来看：**200ms**感受不到延时。**1s**，感受到延时，但是可以接收。之后等待时间越长，用户体验就越差。因此健康系统的99分位值应当控制在200ms以内。而不超过1s的请求占比要在99.99%以上。

# 高并发下的性能优化
## 提高系统的处理核心数
提高系统核心数可以提高性能，但是并不意味着无限制提高核心数就可以无限制提高性能。多核心数意味着资源争抢愈发严重。在某个临界点上继续增加并发进程数，反而会造成系统性能的下降，这就是**拐点模型**。

## 减少单次任务的响应时间
区分是CPU密集型还是IO密集型

### CPU密集型
需要大量的CPU运算，选用更高效的算法，或减少运算次数。可以通过Profile工具来找到消耗cpu时间更多的方法或者模块，如linux的perf,eBPF等

### IO密集型
IO密集型大部分操作都是等待IO完成，如磁盘IO，网络IO。解决方案：采用工具排查，一些开发语言甚至有对应的内存工具。另一类手段是通过监控来发现性能问题，对每个步骤进行分时统计，从而找到任务的消耗时间。

# 可用性度量
## MTBF（Mean Time Between Failure）
平均故障间隔，代表两次故障间隔时间，也就是系统正常运转的平均时间。这个时间越长，系统越稳定

## MTTR （Mean Time To Repair）
故障平均恢复时间。越短影响越小。

# 池化技术（数据库）
数据库连接建立，假设是4ms，查询一条sql语句假设是1ms，一个完整的周期就是5ms，一秒大概能执行200次。而数据库连接的时间占了其中的4/5。

所以利用池化技术，可以预先创建好连接（**预热操作**），如果连接不够就生成新的连接，超过上限就设置等待超时时间。

- 推荐：一般线上环境最小连接数控制在10左右，最大连接数控制在20-30左右

## 可能出现的故障
- 数据库域名IP变更，但是连接池是用旧的连接
- wait_timeout参数，连接闲置过久后，数据库会主动关闭这个连接，对业务后台是无感知的。

## 解决方案
1. 发送select 1，检测是否抛出异常，异常就从连接池中移除（推荐）
2. 获取到连接后，校验连接是否可用，可用在执行（线上不推荐）

## 线程池注意事项
如果使用了线程池，一定不要使用无界队列，大量任务堆积可能会占用大量内存空间，造成服务不可用。

# 主从分离（数据库）